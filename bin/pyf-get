#!/usr/bin/python3

import re
import argparse
import sys
import socket
import xmlrpc.client

import pyfortunes

def main():
    parser = argparse.ArgumentParser()
    pyfortunes.client.configure_parser(parser)
    parser.add_argument("category", nargs='?')
    args = parser.parse_args()
    url = pyfortunes.client.get_url(args)
    category = args.category
    proxy = pyfortunes.client.get_proxy(url)
    fortune = pyfortunes.client.get_fortune(proxy,
        category=category)
    if not fortune.endswith("\n"):
        fortune += "\n"
    sys.stdout.write(fortune)


if __name__ == "__main__":
    try:
        main()
    except xmlrpc.client.Fault as e:
        mess = e.faultString
        # Get rid of the type of the exception:
        mess = re.sub('<.*?>:', '', mess)
        print(mess)
        sys.exit(2)
    except socket.error as e:
        print(e)
        sys.exit(2)
