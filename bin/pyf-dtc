#!/usr/bin/python3

import argparse

from bs4 import BeautifulSoup
import requests
import textwrap

from pyfortunes.db import FortuneDB


def get_quote(id):
    url = "http://danstonchat.com/%s.html" % id
    response = requests.get(url)
    response.encoding = 'utf-8'
    html = response.text
    return extract_quote(html, id)


def extract_quote(html, id):
    soup = BeautifulSoup(html, "html.parser")
    url = "https://danstonchat.com/%s.html" % id
    # The quote is in the first <a> link that points to
    # self url ...
    self_links = soup("a", href=url)
    if not self_links:
        raise Exception("scrapping failed")
    res = ""
    quote = self_links[0]
    # Quote is: <span class > for the pseudo, then some text, then <br />
    # Get only the pseudo, but keep the br and wrap the quote at
    # 80
    res = ""
    reply = ""
    for child in quote.children:
        if not child.name:
            reply += child
        if child.name == "span":
            reply = child.text
        if child.name == "br":
            res += "\n".join(textwrap.wrap(reply))
            res += "\n"
            reply = ""
    # there's no final <br />
    if reply:
        res += "\n".join(textwrap.wrap(reply))
        res += "\n"
    return res


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("id")
    args = parser.parse_args()
    quote_id = args.id
    fortunes_db = FortuneDB()
    quote = get_quote(quote_id)
    fortunes_db.append_and_push(quote, category="bash")


if __name__ == "__main__":
    main()
